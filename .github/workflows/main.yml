name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v2.1 Fix)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬ (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

      include_assets:
        description: 'æ˜¯å¦åŒ…å« assets æ–‡ä»¶å¤¹'
        type: boolean
        required: false
        default: true

jobs:
  build:
    name: ğŸš€ Build on ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # === ä¿®å¤ç‚¹åœ¨è¿™é‡Œ ===
      - name: Install Dependencies & Prepare Icon
        shell: python
        # å…³é”®ä¿®å¤ 1ï¼šè®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶ UTF-8 è¾“å‡º
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import os
          import subprocess
          import sys
          import codecs

          # å…³é”®ä¿®å¤ 2ï¼šåœ¨ä»£ç å†…éƒ¨å¼ºåˆ¶é‡ç½®æ ‡å‡†è¾“å‡ºç¼–ç ï¼Œé˜²æ­¢ crash
          try:
              if sys.stdout.encoding != 'utf-8':
                  sys.stdout.reconfigure(encoding='utf-8')
          except Exception:
              pass

          print("ğŸ“¦ å®‰è£… Nuitka å’Œæ„å»ºå·¥å…·...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          if os.path.exists("requirements.txt"):
              print("ğŸ“š å®‰è£… requirements.txt...")
              with open("requirements.txt", "r", encoding="utf-8") as f:
                  deps = [line.strip() for line in f if "torch" not in line.lower() and line.strip()]
              
              if deps:
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + deps)
          else:
              print("âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œå®‰è£…é»˜è®¤åº“...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python"])

          print("ğŸ¨ å¤„ç†å›¾æ ‡...")
          from PIL import Image
          
          icon_target = "icon.ico"
          source_imgs = ["icon.ico", "480x480.png", "108x108.png", "28x28.png", "icon.png", "logo.png"]
          
          found_icon = False
          
          if os.path.exists(icon_target):
              print(f"âœ… å‘ç°ç°æˆçš„ {icon_target}")
              found_icon = True
          else:
              for img_name in source_imgs:
                  if os.path.exists(img_name):
                      print(f"ğŸ”„ æ­£åœ¨è½¬æ¢ {img_name}...")
                      try:
                          img = Image.open(img_name)
                          img.save(icon_target, format='ICO', sizes=[(256, 256), (128, 128), (64, 64), (48, 48), (32, 32), (16, 16)])
                          print(f"âœ… è½¬æ¢æˆåŠŸ")
                          found_icon = True
                          break
                      except Exception as e:
                          print(f"âŒ è½¬æ¢å¤±è´¥: {e}")
          
          if found_icon:
              with open("HAS_ICON", "w") as f: f.write("yes")

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          follow-imports: true
          
          enable-plugins: |
            numpy
            torch
            tk-inter
            pyside6
            pygame
            anti-bloat
          
          disable-console: true
          assume-yes-for-downloads: true
          lto: no
          
          windows-icon-from-ico: icon.ico
          
          include-data-dir: |
            ${{ inputs.include_assets && 'assets=assets' || '' }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
