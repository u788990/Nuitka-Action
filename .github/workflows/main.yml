name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v2.0 Pro)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬ (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

      include_assets:
        description: 'æ˜¯å¦åŒ…å« assets æ–‡ä»¶å¤¹'
        type: boolean
        required: false
        default: true

jobs:
  build:
    name: ğŸš€ Build on ${{ matrix.os }}
    # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼Œæ–¹ä¾¿æœªæ¥æ‰©å±•
    strategy:
      matrix:
        os: [windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Check-out repository
        uses: actions/checkout@v4

      # 2. é…ç½® Python 3.12 + ç¼“å­˜åŠ é€Ÿ
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # å‡çº§åˆ°æœ€æ–°
          cache: 'pip'
          # æŒ‡å®šä¾èµ–æ–‡ä»¶è·¯å¾„ï¼Œæ˜¾è‘—åŠ é€Ÿåç»­æ„å»º
          cache-dependency-path: 'requirements.txt'

      # 3. å®‰è£…ä¾èµ– & æ™ºèƒ½å¤„ç†å›¾æ ‡ (æ ¸å¿ƒä¼˜åŒ–)
      - name: Install Dependencies & Prepare Icon
        shell: python
        run: |
          import os
          import subprocess
          import sys

          # --- A. å®‰è£…åŸºç¡€å·¥å…· ---
          print("ğŸ“¦ å®‰è£… Nuitka å’Œæ„å»ºå·¥å…·...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          # å®‰è£… Pillow ç”¨äºå¤„ç†å›¾ç‰‡è½¬æ¢
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          # --- B. å¼ºåˆ¶å®‰è£… CPU ç‰ˆ Torch (å‡å°ä½“ç§¯) ---
          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          # --- C. å®‰è£…ç”¨æˆ·ä¾èµ– ---
          if os.path.exists("requirements.txt"):
              print("ğŸ“š å®‰è£… requirements.txt...")
              # ç®€å•çš„è¿‡æ»¤ torch é€»è¾‘ï¼Œé¿å…è¦†ç›–å®‰è£…
              with open("requirements.txt", "r", encoding="utf-8") as f:
                  deps = [line.strip() for line in f if "torch" not in line.lower() and line.strip()]
              
              if deps:
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + deps)
          else:
              print("âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œå®‰è£…é»˜è®¤åº“...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python"])

          # --- D. æ™ºèƒ½å›¾æ ‡è½¬æ¢ (è§£å†³å›¾æ ‡æ˜¯è›‡çš„é—®é¢˜) ---
          print("ğŸ¨ å¤„ç†å›¾æ ‡...")
          from PIL import Image
          
          # ä¼˜å…ˆçº§ï¼šicon.ico > 480x480.png > 108x108.png > 28x28.png
          icon_target = "icon.ico"
          source_imgs = ["icon.ico", "480x480.png", "108x108.png", "28x28.png", "icon.png", "logo.png"]
          
          found_icon = False
          
          # å¦‚æœ icon.ico å·²ç»å­˜åœ¨ï¼Œç›´æ¥ç”¨
          if os.path.exists(icon_target):
              print(f"âœ… å‘ç°ç°æˆçš„ {icon_target}ï¼Œå°†ä½¿ç”¨æ­¤å›¾æ ‡ã€‚")
              found_icon = True
          else:
              # å¦åˆ™å¯»æ‰¾ png å¹¶è½¬æ¢
              for img_name in source_imgs:
                  if os.path.exists(img_name):
                      print(f"ğŸ”„ å‘ç° {img_name}ï¼Œæ­£åœ¨è½¬æ¢ä¸ºé«˜è´¨é‡ icon.ico...")
                      try:
                          img = Image.open(img_name)
                          # è½¬æ¢ä¸ºåŒ…å«å¤šç§å°ºå¯¸çš„ ICO
                          img.save(icon_target, format='ICO', sizes=[(256, 256), (128, 128), (64, 64), (48, 48), (32, 32), (16, 16)])
                          print(f"âœ… è½¬æ¢æˆåŠŸï¼š{icon_target}")
                          found_icon = True
                          break
                      except Exception as e:
                          print(f"âŒ è½¬æ¢å¤±è´¥: {e}")
          
          # è¿™æ˜¯ä¸€ä¸ªæ ‡è®°æ–‡ä»¶ï¼Œåç»­æ­¥éª¤ç”¨å®ƒæ¥å†³å®šæ˜¯å¦å¯ç”¨å›¾æ ‡å‚æ•°
          if found_icon:
              with open("HAS_ICON", "w") as f: f.write("yes")

      # 4. æ‰§è¡Œ Nuitka æ‰“åŒ…
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # æ˜¾å¼å¼€å¯å¯¼å…¥è·Ÿè¸ª
          follow-imports: true
          
          # === æ’ä»¶é…ç½® (å¤šè¡Œå†™æ³•ï¼Œæ¸…æ™°) ===
          enable-plugins: |
            numpy
            torch
            tk-inter
            pyside6
            pygame
            anti-bloat
          
          # === ç•Œé¢æ§åˆ¶ (ä¿®æ­£å‚æ•°å) ===
          disable-console: true
          
          # === ç¼–è¯‘ç¯å¢ƒ ===
          assume-yes-for-downloads: true
          lto: no
          
          # === å…³é”®ï¼šå›¾æ ‡è®¾ç½® ===
          # è¿™é‡Œç¡¬ç¼–ç  icon.icoï¼Œå› ä¸ºä¸Šä¸€æ­¥çš„è„šæœ¬ä¿è¯äº†å¦‚æœä»“åº“æœ‰å›¾ï¼Œ
          # å°±ä¼šç”Ÿæˆè¿™ä¸ª icon.ico æ–‡ä»¶ã€‚å¦‚æœä»“åº“å®Œå…¨æ²¡å›¾ï¼ŒNuitka ä¼šå¿½ç•¥ç¼ºå¤±çš„æ–‡ä»¶è­¦å‘Šæˆ–ä½¿ç”¨é»˜è®¤
          windows-icon-from-ico: icon.ico
          
          # === èµ„æºæ–‡ä»¶ ===
          include-data-dir: |
            ${{ inputs.include_assets && 'assets=assets' || '' }}

      # 5. ä¸Šä¼ ç»“æœ
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
