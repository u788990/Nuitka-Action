name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v3.2 æˆªè‚¢æ±‚ç”Ÿç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      # === 1. è™šæ‹Ÿå†…å­˜é…ç½® (åŠ å¼ºç‰ˆ) ===
      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.3
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸ›¡ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤
        shell: python
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import os
          import sys
          import subprocess
          from pathlib import Path

          try:
              if sys.stdout.encoding != 'utf-8':
                  sys.stdout.reconfigure(encoding='utf-8')
          except: pass

          print(f"{'='*30}\nğŸ› ï¸ ç¯å¢ƒè‡ªæ£€\n{'='*30}")

          # ä¿®å¤ assets
          assets_dir = Path("assets")
          if not assets_dir.exists():
              print("âš ï¸ åˆ›å»ºç©º assets ç›®å½•...")
              assets_dir.mkdir()
              (assets_dir / ".keep").touch()

          # å®‰è£…ä¾èµ–
          print("ğŸ“¦ å®‰è£…ä¾èµ–...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          # å®‰è£… Torch CPU
          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          # å®‰è£… requirements.txt
          if os.path.exists("requirements.txt"):
              print("ğŸ“š è§£æ requirements.txt...")
              valid_deps = []
              try:
                  with open("requirements.txt", "r", encoding="utf-8") as f: lines = f.readlines()
              except:
                  with open("requirements.txt", "r", encoding="gbk") as f: lines = f.readlines()
                      
              for line in lines:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  if "torch" in line.lower(): continue
                  # è¿‡æ»¤æ‰ PyQt6/PySide6 é˜²æ­¢å†²çªï¼Œåªç•™ PyQt5
                  if "pyside6" in line.lower(): continue 
                  if "pyqt6" in line.lower(): continue
                  valid_deps.append(line)
              
              if valid_deps:
                  print(f"ğŸ“¦ å®‰è£… {len(valid_deps)} ä¸ªé¡¹ç›®ä¾èµ–...")
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + valid_deps)
          else:
              print("âš ï¸ å®‰è£…é»˜è®¤ä¾èµ–...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python", "PyQt5"])

          # å›¾æ ‡ç”Ÿæˆ
          print("ğŸ¨ å›¾æ ‡æ£€æŸ¥...")
          from PIL import Image, ImageDraw
          icon_target = "icon.ico"
          if not os.path.exists(icon_target):
              print("âš ï¸ ç”Ÿæˆé»˜è®¤å›¾æ ‡...")
              img = Image.new('RGB', (256, 256), color = (0, 120, 215))
              d = ImageDraw.Draw(img)
              d.text((20,100), "APP", fill=(255,255,255))
              img.save(icon_target, format='ICO')

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === å…³é”®ä¿®å¤ï¼šç¦æ­¢è·Ÿéš sympy ===
          # è¿™ä¼šå‘Šè¯‰ Nuitkaï¼šä¸è¦å»ç¼–è¯‘ sympy åº“
          # è¿™æ ·å°±å½»åº•é¿å¼€äº†é‚£ä¸ªå¯¼è‡´å´©æºƒçš„ C æ–‡ä»¶
          nofollow-import-to: sympy
          
          # === å¼€å¯ä½å†…å­˜æ¨¡å¼ ===
          low-memory: true
          
          # é™åˆ¶å¹¶å‘ï¼Œé˜²æ­¢å†…å­˜çˆ†ç‚¸
          jobs: 1
          
          # æ’ä»¶é…ç½®
          enable-plugins: |
            tk-inter
            pyqt5
            anti-bloat
          
          # æ’é™¤ numba (æ—¥å¿—è­¦å‘Šé‡Œæåˆ°çš„æ‹–æ…¢å› ç´ )
          noinclude-numba-mode: nofollow
          
          # å…³é—­æ§åˆ¶å°
          windows-console-mode: disable
          
          assume-yes-for-downloads: true
          lto: no
          
          windows-icon-from-ico: icon.ico
          include-data-dir: assets=assets

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
