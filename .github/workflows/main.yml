name: Ultimate Nuitka Build (Requirements-First)

on:
  workflow_dispatch:
    inputs:
      entry_point:
        description: '入口 Python 文件'
        required: true
        default: 'biekuai.py'
      icon_file:
        description: '图标文件 (留空则自动检测)'
        required: false
        default: 'exe.ico'
      output_name:
        description: '生成的程序名称 (留空则使用入口文件名)'
        required: false
        default: ''
      build_mode:
        description: '打包模式'
        required: true
        default: 'onefile'
        type: choice
        options:
          - onefile
          - standalone

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Free Disk Space (Deep Cleanup)
        shell: pwsh
        run: |
          Write-Host "Cleaning up disk..."
          Remove-TypeData * -ErrorAction SilentlyContinue
          $ErrorActionPreference = 'SilentlyContinue'
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidSDK"
          Remove-Item -Recurse -Force "$env:AGENT_TOOLSDIRECTORY\CodeQL"
          Remove-Item -Path "C:\Users\runneradmin\AppData\Local\Temp\*" -Recurse -Force
          [System.GC]::Collect()

      - name: Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            Write-Host ">>> Installing from requirements.txt..."
            pip install -r requirements.txt
          } else {
            Write-Host ">>> No requirements.txt found. Installing default packages..."
            pip install zstandard ordered-set opencv-python Pillow numpy tkinterdnd2 PySide6
          }

      - name: Auto-Detect Nuitka Settings
        id: detect
        shell: pwsh
        run: |
          # 1. 确定入口文件
          $entry = "${{ github.event.inputs.entry_point }}"
          if (!(Test-Path $entry)) { $entry = Get-ChildItem -Filter "*.py" | Select-Object -First 1 -ExpandProperty Name }

          # 2. 仅分析 Nuitka 插件需求 (不干扰 pip)
          $code = Get-Content $entry -Raw
          $plugins = @()
          $pkg_data = ""
          
          if ($code -match "PySide6") { $plugins += "pyside6" }
          if ($code -match "tkinter") { $plugins += "tk-inter" }
          if ($code -match "tkinterdnd2") { $pkg_data = "tkinterdnd2" }

          # 3. 图标检测
          $icon = "${{ github.event.inputs.icon_file }}"
          if ($icon -eq "" -or !(Test-Path $icon)) { 
            $foundIcon = Get-ChildItem -Filter "*.ico" | Select-Object -First 1
            $icon = if ($foundIcon) { $foundIcon.Name } else { "" } 
          }

          # 4. 程序名称
          $name = "${{ github.event.inputs.output_name }}"
          if ($name -eq "") { $name = [System.IO.Path]::GetFileNameWithoutExtension($entry) }

          echo "entry=$entry" >> $env:GITHUB_OUTPUT
          echo "name=$name" >> $env:GITHUB_OUTPUT
          echo "icon=$icon" >> $env:GITHUB_OUTPUT
          echo "plugins=$(($plugins | Select-Object -Unique) -join ',')" >> $env:GITHUB_OUTPUT
          echo "pkg_data=$pkg_data" >> $env:GITHUB_OUTPUT

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ steps.detect.outputs.entry }}
          output-file: ${{ steps.detect.outputs.name }}
          output-dir: build
          mode: ${{ github.event.inputs.build_mode }}
          
          # 插件与数据包含 (基于代码检测)
          enable-plugins: ${{ steps.detect.outputs.plugins }}
          include-package-data: ${{ steps.detect.outputs.pkg_data }}
          
          # 自动包含 FFmpeg 文件夹逻辑
          include-data-dir: ${{ hashFiles('fongzhuang/*') != '' && 'fongzhuang=fongzhuang' || '' }}
          
          # 拖拽修复：禁用管理员权限，隐藏控制台
          windows-uac-admin: false
          disable-console: true
          windows-icon-from-ico: ${{ steps.detect.outputs.icon }}
          
          assume-yes-for-downloads: true
          onefile-tempdir-spec: "{CACHE_DIR}/${{ steps.detect.outputs.name }}/v1"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.detect.outputs.name }}-Binary
          path: build/*.exe
