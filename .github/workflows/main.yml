name: Ultimate Smart Nuitka Build (Fixed Parameters)

on:
  workflow_dispatch:
    inputs:
      entry_point:
        description: '入口 Python 文件'
        required: true
        default: 'biekuai.py'
      icon_file:
        description: '图标文件'
        required: false
        default: 'exe.ico'
      output_name:
        description: '程序名称'
        required: false
        default: ''
      build_mode:
        description: '模式'
        required: true
        default: 'onefile'
        type: choice
        options:
          - onefile
          - standalone

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Free Disk Space
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidSDK" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "$env:AGENT_TOOLSDIRECTORY\CodeQL" -ErrorAction SilentlyContinue
          [System.GC]::Collect()

      - name: Smart Analysis
        id: detect
        shell: pwsh
        run: |
          $entry = "${{ github.event.inputs.entry_point }}"
          if (!(Test-Path $entry)) { $entry = Get-ChildItem -Filter "*.py" | Select-Object -First 1 -ExpandProperty Name }
          
          $code = Get-Content $entry -Raw
          $imports = [regex]::Matches($code, '(?m)^(?:from|import)\s+([\w\d]+)') | ForEach-Object { $_.Groups[1].Value.ToLower() }
          
          # 映射表
          $pkg_map = @{ "cv2"="opencv-python"; "pil"="Pillow"; "numpy"="numpy"; "pyside6"="PySide6"; "rembg"="rembg"; "onnxruntime"="onnxruntime"; "psutil"="psutil"; "imageio"="imageio"; "tkinterdnd2"="tkinterdnd2" }
          
          $install_list = @("zstandard", "ordered-set")
          $auto_plugins = @()
          $include_pkg_data = "" # 专门给 tkinterdnd2 用

          foreach ($mod in $imports) {
            if ($pkg_map.ContainsKey($mod)) { $install_list += $pkg_map[$mod] }
            if ($mod -eq "pyside6") { $auto_plugins += "pyside6" }
            if ($mod -eq "tkinter") { $auto_plugins += "tk-inter" }
            # 特殊处理：记录需要包含数据的包名
            if ($mod -eq "tkinterdnd2") { $include_pkg_data = "tkinterdnd2" }
          }

          # 图标与名称逻辑 (保留)
          $icon = "${{ github.event.inputs.icon_file }}"
          if ($icon -eq "" -or !(Test-Path $icon)) { $foundIcon = Get-ChildItem -Filter "*.ico" | Select-Object -First 1; $icon = if ($foundIcon) { $foundIcon.Name } else { "" } }
          $name = "${{ github.event.inputs.output_name }}"
          if ($name -eq "") { $name = [System.IO.Path]::GetFileNameWithoutExtension($entry) }

          # 导出
          echo "entry=$entry" >> $env:GITHUB_OUTPUT
          echo "name=$name" >> $env:GITHUB_OUTPUT
          echo "icon=$icon" >> $env:GITHUB_OUTPUT
          echo "pkgs=$(($install_list | Select-Object -Unique) -join ' ')" >> $env:GITHUB_OUTPUT
          echo "plugins=$(($auto_plugins | Select-Object -Unique) -join ',')" >> $env:GITHUB_OUTPUT
          echo "pkg_data=$include_pkg_data" >> $env:GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ${{ steps.detect.outputs.pkgs }}
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ steps.detect.outputs.entry }}
          output-file: ${{ steps.detect.outputs.name }}
          output-dir: build
          mode: ${{ github.event.inputs.build_mode }}
          
          # 核心修正：使用插件支持的正确输入项
          enable-plugins: ${{ steps.detect.outputs.plugins }}
          
          # 专门处理 tkinterdnd2 的数据包含
          include-package-data: ${{ steps.detect.outputs.pkg_data }}
          
          # 专门处理 FFmpeg 文件夹包含 (如果文件夹存在)
          include-data-dir: ${{ hashFiles('fongzhuang/*') != '' && 'fongzhuang=fongzhuang' || '' }}
          
          # 权限修复：关闭盾牌，恢复拖拽
          windows-uac-admin: false
          disable-console: true
          windows-icon-from-ico: ${{ steps.detect.outputs.icon }}
          
          # 性能优化
          assume-yes-for-downloads: true
          onefile-tempdir-spec: "{CACHE_DIR}/${{ steps.detect.outputs.name }}/v1"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.detect.outputs.name }}-Binary
          path: build/*.exe
