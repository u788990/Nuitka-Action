name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v3.0 ç»ˆæé˜²å¾¡ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬ (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸ›¡ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤ (å…³é”®æ­¥éª¤)
        shell: python
        # å¼ºåˆ¶ UTF-8 é¿å…ä¸­æ–‡æŠ¥é”™
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import os
          import sys
          import subprocess
          from pathlib import Path

          # --- 1. é˜²æ­¢ä¸­æ–‡è¾“å‡ºä¹±ç  ---
          try:
              if sys.stdout.encoding != 'utf-8':
                  sys.stdout.reconfigure(encoding='utf-8')
          except: pass

          print(f"{'='*30}\nğŸ› ï¸ å¼€å§‹ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤\n{'='*30}")

          # --- 2. ä¿®å¤ assets æ–‡ä»¶å¤¹ç¼ºå¤±å¯¼è‡´çš„å´©æºƒ ---
          # ä½ çš„æŠ¥é”™å°±æ˜¯è¿™é‡Œå¼•èµ·çš„ï¼šNuitka æ‰¾ä¸åˆ° assets å°±ä¼šæ­»
          # ä¿®å¤é€»è¾‘ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºçš„ï¼Œä¿è¯å‘½ä»¤ä¸æŠ¥é”™
          assets_dir = Path("assets")
          if not assets_dir.exists():
              print("âš ï¸ æœªæ£€æµ‹åˆ° assets æ–‡ä»¶å¤¹ï¼Œæ­£åœ¨è‡ªåŠ¨åˆ›å»ºç©ºç›®å½•ä»¥é˜²æŠ¥é”™...")
              assets_dir.mkdir()
          else:
              print("âœ… æ£€æµ‹åˆ° assets èµ„æºæ–‡ä»¶å¤¹")

          # --- 3. å®‰è£…åŸºç¡€å·¥å…· ---
          print("ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          # --- 4. æ™ºèƒ½å®‰è£… Torch (CPUç‰ˆ) ---
          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch (åŠ é€Ÿæ‰“åŒ…)...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          # --- 5. æ™ºèƒ½è§£æ requirements.txt ---
          if os.path.exists("requirements.txt"):
              print("ğŸ“š è§£æ requirements.txt...")
              valid_deps = []
              try:
                  with open("requirements.txt", "r", encoding="utf-8") as f:
                      lines = f.readlines()
              except UnicodeDecodeError:
                  # é˜²æ­¢ ANSI ç¼–ç å¯¼è‡´æŠ¥é”™
                  with open("requirements.txt", "r", encoding="gbk") as f:
                      lines = f.readlines()
                      
              for line in lines:
                  line = line.strip()
                  # è¿‡æ»¤æ³¨é‡Šã€ç©ºè¡Œ
                  if not line or line.startswith('#'): continue
                  # è¿‡æ»¤å·²æ‰‹åŠ¨å®‰è£…çš„å†²çªåŒ…
                  if "torch" in line.lower(): continue
                  if "pyside6" in line.lower(): continue 
                  valid_deps.append(line)
              
              if valid_deps:
                  print(f"ğŸ“¦ å®‰è£… {len(valid_deps)} ä¸ªé¡¹ç›®ä¾èµ–...")
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + valid_deps)
          else:
              print("âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œå®‰è£…é»˜è®¤æ¸¸æˆåº“...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python", "PyQt5"])

          # --- 6. ç»ˆæå›¾æ ‡ä¿®å¤ (é˜²æ­¢å›¾æ ‡ç¼ºå¤±æŠ¥é”™) ---
          print("ğŸ¨ å›¾æ ‡æ£€æŸ¥ä¸ç”Ÿæˆ...")
          from PIL import Image, ImageDraw
          
          icon_target = "icon.ico"
          # å¦‚æœ icon.ico ä¸å­˜åœ¨ï¼Œæ‰¾å…¶ä»–å›¾ç‰‡è½¬ï¼›å¦‚æœè¿å…¶ä»–å›¾ç‰‡éƒ½æ²¡æœ‰ï¼Œç›´æ¥ç”»ä¸€ä¸ªï¼
          if not os.path.exists(icon_target):
              source_imgs = ["480x480.png", "108x108.png", "28x28.png", "icon.png", "logo.png"]
              found = False
              for img in source_imgs:
                  if os.path.exists(img):
                      print(f"ğŸ”„ å°† {img} è½¬æ¢ä¸º icon.ico")
                      Image.open(img).save(icon_target, format='ICO', sizes=[(256,256)])
                      found = True
                      break
              
              if not found:
                  print("âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å›¾ç‰‡ï¼Œæ­£åœ¨ç”Ÿæˆé»˜è®¤è“è‰²å›¾æ ‡...")
                  img = Image.new('RGB', (256, 256), color = (73, 109, 137))
                  d = ImageDraw.Draw(img)
                  d.text((10,10), "GAME", fill=(255,255,0))
                  img.save(icon_target, format='ICO')
          
          print("âœ… ç¯å¢ƒå‡†å¤‡å®Œæ¯•ï¼")

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === æ’ä»¶é…ç½® ===
          # ç§»é™¤äº†æ‰€æœ‰å¯èƒ½å¯¼è‡´æŠ¥é”™çš„æ’ä»¶ï¼Œåªä¿ç•™æœ€ç¨³çš„
          # Nuitka ç°åœ¨çš„è‡ªåŠ¨æ£€æµ‹å·²ç»å¾ˆå¼ºäº†
          enable-plugins: |
            numpy
            torch
            tk-inter
            pyqt5
            anti-bloat
          
          disable-console: true
          assume-yes-for-downloads: true
          lto: no
          
          # å¼ºåˆ¶æŒ‡å®šå›¾æ ‡ï¼ˆä¸Šä¸€æ­¥è„šæœ¬ä¿è¯äº†æ–‡ä»¶ä¸€å®šå­˜åœ¨ï¼‰
          windows-icon-from-ico: icon.ico
          
          # å¼ºåˆ¶åŒ…å« assetsï¼ˆä¸Šä¸€æ­¥è„šæœ¬ä¿è¯äº†æ–‡ä»¶å¤¹ä¸€å®šå­˜åœ¨ï¼‰
          include-data-dir: assets=assets

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
