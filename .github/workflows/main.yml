name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v3.1 å†…å­˜æ•‘æ´ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬ (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      # === å…³é”®æ­¥éª¤ 1ï¼šå¢åŠ è™šæ‹Ÿå†…å­˜ ===
      # GitHub Runner åªæœ‰ 7GB å†…å­˜ï¼Œç¼–è¯‘ Torch/Sympy å¿…å´©
      # è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶å¢åŠ  10GB è™šæ‹Ÿå†…å­˜ (Pagefile)
      - name: Increase Pagefile Size
        run: |
          (Get-CimInstance Win32_ComputerSystem).AutomaticManagedPagefile = $false
          (Get-CimInstance Win32_PageFileSetting).InitialSize = 10240
          (Get-CimInstance Win32_PageFileSetting).MaximumSize = 10240
          echo "âœ… è™šæ‹Ÿå†…å­˜å·²å¢åŠ è‡³ 10GB"
        shell: powershell

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸ›¡ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤
        shell: python
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import os
          import sys
          import subprocess
          from pathlib import Path

          try:
              if sys.stdout.encoding != 'utf-8':
                  sys.stdout.reconfigure(encoding='utf-8')
          except: pass

          print(f"{'='*30}\nğŸ› ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤\n{'='*30}")

          # ä¿®å¤ assets
          assets_dir = Path("assets")
          if not assets_dir.exists():
              print("âš ï¸ åˆ›å»ºç©º assets ç›®å½•é˜²æ­¢æŠ¥é”™...")
              assets_dir.mkdir()
              # åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œé˜²æ­¢ Nuitka æŠ±æ€¨ç›®å½•ä¸ºç©º
              (assets_dir / ".keep").touch()

          # å®‰è£…ä¾èµ–
          print("ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          # å®‰è£… Torch CPU ç‰ˆ
          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          # å®‰è£… requirements.txt
          if os.path.exists("requirements.txt"):
              print("ğŸ“š è§£æ requirements.txt...")
              valid_deps = []
              try:
                  with open("requirements.txt", "r", encoding="utf-8") as f: lines = f.readlines()
              except:
                  with open("requirements.txt", "r", encoding="gbk") as f: lines = f.readlines()
                      
              for line in lines:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  if "torch" in line.lower(): continue
                  if "pyside6" in line.lower(): continue 
                  valid_deps.append(line)
              
              if valid_deps:
                  print(f"ğŸ“¦ å®‰è£… {len(valid_deps)} ä¸ªé¡¹ç›®ä¾èµ–...")
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + valid_deps)
          else:
              print("âš ï¸ å®‰è£…é»˜è®¤ä¾èµ–...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python", "PyQt5"])

          # å›¾æ ‡ç”Ÿæˆ
          print("ğŸ¨ å›¾æ ‡æ£€æŸ¥...")
          from PIL import Image, ImageDraw
          icon_target = "icon.ico"
          if not os.path.exists(icon_target):
              print("âš ï¸ ç”Ÿæˆé»˜è®¤å›¾æ ‡...")
              img = Image.new('RGB', (256, 256), color = (73, 109, 137))
              d = ImageDraw.Draw(img)
              d.text((10,10), "GAME", fill=(255,255,0))
              img.save(icon_target, format='ICO')

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === å…³é”®æ­¥éª¤ 2ï¼šé™åˆ¶å¹¶å‘ ===
          # é™åˆ¶ä¸º 1 ä¸ªçº¿ç¨‹ï¼Œé˜²æ­¢åŒæ—¶ç¼–è¯‘å¤šä¸ªå¤§æ–‡ä»¶æ’‘çˆ†å†…å­˜
          jobs: 1
          
          # === å…³é”®æ­¥éª¤ 3ï¼šé…ç½®æ¸…ç† ===
          # æ ¹æ®æ—¥å¿—è­¦å‘Šï¼Œç§»é™¤äº† numpy å’Œ torch æ’ä»¶ï¼ˆå·²å†…ç½®ï¼‰
          # ä»…ä¿ç•™ç•Œé¢åº“å’Œé˜²è†¨èƒ€
          enable-plugins: |
            tk-inter
            pyqt5
            anti-bloat
          
          # ä¿®å¤å‚æ•°åè­¦å‘Š
          windows-console-mode: disable
          
          # ä¼˜åŒ–å‚æ•°
          assume-yes-for-downloads: true
          lto: no
          
          # æ’é™¤ numba å¹²æ‰° (æ—¥å¿—å»ºè®®)
          noinclude-numba-mode: nofollow
          
          windows-icon-from-ico: icon.ico
          include-data-dir: assets=assets

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
