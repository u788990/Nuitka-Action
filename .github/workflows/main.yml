name: ‚òÅÔ∏è ‰∫ëÁ´Ø Nuitka ÊûÅÈÄüÊâìÂåÖ (v5.0 Á®≥ÂÆö‰øÆÂ§çÁâà)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python ÂÖ•Âè£ËÑöÊú¨'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'ÊâìÂåÖÊ®°Âºè'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: üöÄ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      # === 1. ËôöÊãüÂÜÖÂ≠òÈÖçÁΩÆ ===
      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.4
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: üõ°Ô∏è ÁéØÂ¢ÉËá™Ê£Ä‰∏é‰øÆÂ§ç
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          
          Write-Host "==============================" -ForegroundColor Cyan
          Write-Host "Environment Setup" -ForegroundColor Cyan
          Write-Host "==============================" -ForegroundColor Cyan
          
          # ÂàõÂª∫ assets ÁõÆÂΩï
          if (-not (Test-Path "assets")) {
              Write-Host "[WARN] Creating empty assets directory..."
              New-Item -ItemType Directory -Path "assets" -Force | Out-Null
              New-Item -ItemType File -Path "assets/.keep" -Force | Out-Null
          }
          
          # ÂçáÁ∫ß pip
          Write-Host "[INFO] Upgrading pip..."
          python -m pip install --upgrade pip -q
          
          # ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑
          Write-Host "[INFO] Installing build tools..."
          python -m pip install wheel nuitka zstandard pillow -q
          
          # ÂÆâË£Ö Torch CPU ÁâàÊú¨
          Write-Host "[INFO] Installing CPU Torch..."
          python -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu -q
          
          # Ëß£ÊûêÂπ∂ÂÆâË£Ö requirements.txt
          if (Test-Path "requirements.txt") {
              Write-Host "[INFO] Parsing requirements.txt..."
              $content = Get-Content "requirements.txt" -Encoding UTF8
              $validDeps = @()
              $skipKeywords = @("torch", "pyside6", "pyqt6", "numba")
              
              foreach ($line in $content) {
                  $line = $line.Trim()
                  if ([string]::IsNullOrEmpty($line) -or $line.StartsWith("#")) { continue }
                  
                  $skip = $false
                  foreach ($kw in $skipKeywords) {
                      if ($line.ToLower().Contains($kw)) { $skip = $true; break }
                  }
                  if (-not $skip) { $validDeps += $line }
              }
              
              if ($validDeps.Count -gt 0) {
                  Write-Host "[INFO] Installing $($validDeps.Count) dependencies..."
                  foreach ($dep in $validDeps) {
                      try {
                          python -m pip install $dep -q 2>$null
                      } catch {
                          Write-Host "[WARN] Skipped: $dep"
                      }
                  }
              }
          } else {
              Write-Host "[WARN] No requirements.txt, installing defaults..."
              python -m pip install pygame numpy pandas opencv-python PyQt5 -q
          }
          
          # ÂõæÊ†áÁîüÊàê
          Write-Host "[INFO] Checking icon..."
          if (-not (Test-Path "icon.ico")) {
              Write-Host "[WARN] Generating default icon..."
              python -c @"
          from PIL import Image, ImageDraw
          img = Image.new('RGB', (256, 256), color=(0, 120, 215))
          d = ImageDraw.Draw(img)
          d.text((100, 110), 'APP', fill=(255, 255, 255))
          img.save('icon.ico', format='ICO')
          "@
              Write-Host "[INFO] Default icon created."
          }
          
          Write-Host "[INFO] Environment setup completed."

      # === 2. Nuitka ÁºìÂ≠òÈÖçÁΩÆ ===
      - name: Setup Nuitka Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/nuitka_cache
            ~\AppData\Local\Nuitka
          key: nuitka-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            nuitka-${{ runner.os }}-

      # === 3. Nuitka ÁºñËØë ===
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          nofollow-import-to: |
            sympy
            tkinter
            unittest
            test
            tests
            scipy.linalg
            matplotlib.tests
            pytest
            setuptools
            distutils
            doctest
          
          enable-plugins: pyqt5
          
          noinclude-numba-mode: nofollow
          
          module-parameter: torch-disable-jit=yes
          
          include-data-dir: assets=assets
          
          windows-icon-from-ico: icon.ico
          
          windows-console-mode: disable
          
          output-dir: build
          
          assume-yes-for-downloads: true
          
          lto: no
          
          low-memory: true
          
          company-name: "Your Company"
          product-name: "Your Product"
          file-version: "1.0.0.0"
          product-version: "1.0.0.0"
          file-description: "Python Application"

      # === 4. ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ© ===
      - name: üì¶ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ inputs.build_mode }}
          path: |
            build/*.exe
            build/*.dist/
          retention-days: 30
          include-hidden-files: true

      # === 5. ÊûÑÂª∫‰ø°ÊÅØËæìÂá∫ ===
      - name: üìä Build Summary
        if: always()
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          Write-Host ""
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "Build Summary" -ForegroundColor Cyan
          Write-Host "==================================================" -ForegroundColor Cyan
          
          if (Test-Path "build") {
              $exeFiles = Get-ChildItem -Path "build" -Filter "*.exe" -Recurse
              if ($exeFiles.Count -gt 0) {
                  Write-Host ""
                  Write-Host "[SUCCESS] Generated $($exeFiles.Count) executable(s):" -ForegroundColor Green
                  foreach ($f in $exeFiles) {
                      $sizeMB = [math]::Round($f.Length / 1MB, 2)
                      Write-Host "  - $($f.Name) ($sizeMB MB)"
                  }
              } else {
                  Write-Host ""
                  Write-Host "[WARN] No .exe files found" -ForegroundColor Yellow
              }
              
              $distDirs = Get-ChildItem -Path "build" -Filter "*.dist" -Directory
              if ($distDirs.Count -gt 0) {
                  Write-Host ""
                  Write-Host "[INFO] Distribution folders:" -ForegroundColor Cyan
                  foreach ($d in $distDirs) {
                      $totalSize = (Get-ChildItem -Path $d.FullName -Recurse -File | Measure-Object -Property Length -Sum).Sum
                      $totalSizeMB = [math]::Round($totalSize / 1MB, 2)
                      Write-Host "  - $($d.Name) ($totalSizeMB MB total)"
                  }
              }
          } else {
              Write-Host ""
              Write-Host "[ERROR] Build directory does not exist" -ForegroundColor Red
          }
