name: ‚òÅÔ∏è ‰∫ëÁ´Ø Nuitka ÊûÅÈÄüÊâìÂåÖ (v5.4 rembg‰øÆÂ§çÁâà)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python ÂÖ•Âè£ËÑöÊú¨'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'ÊâìÂåÖÊ®°Âºè'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile
      
      icon_file:
        description: 'ICO ÂõæÊ†áÊñá‰ª∂Âêç'
        required: true
        default: 'exe.ico'

jobs:
  build:
    name: üöÄ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.4
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        shell: pwsh
        run: |
          Write-Host "=== Upgrading pip ===" -ForegroundColor Cyan
          python -m pip install --upgrade pip
          
          Write-Host "=== Installing build tools ===" -ForegroundColor Cyan
          python -m pip install wheel nuitka zstandard pillow ordered-set
          
          Write-Host "=== Installing CPU Torch ===" -ForegroundColor Cyan
          python -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          
          Write-Host "=== Installing PySide6 ===" -ForegroundColor Cyan
          python -m pip install PySide6
          
          Write-Host "=== Installing rembg with all dependencies ===" -ForegroundColor Cyan
          python -m pip install rembg[cli] onnxruntime pooch
          
          Write-Host "=== Installing imageio ===" -ForegroundColor Cyan
          python -m pip install imageio imageio-ffmpeg
          
          Write-Host "=== Installing other dependencies ===" -ForegroundColor Cyan
          python -m pip install opencv-python numpy psutil scikit-image scipy
          
          Write-Host "=== Installing project dependencies ===" -ForegroundColor Cyan
          if (Test-Path "requirements.txt") {
              $content = Get-Content "requirements.txt" -Raw
              $lines = $content -split "`n"
              $skipKeywords = @("torch", "pyside6", "pyqt6", "numba", "cuda", "rembg", "onnxruntime", "imageio", "opencv", "numpy", "psutil", "scikit", "scipy", "pooch")
              
              foreach ($line in $lines) {
                  $line = $line.Trim()
                  if ([string]::IsNullOrEmpty($line) -or $line.StartsWith("#")) { continue }
                  
                  $skip = $false
                  foreach ($kw in $skipKeywords) {
                      if ($line.ToLower().Contains($kw)) { 
                          Write-Host "Skipping: $line" -ForegroundColor Yellow
                          $skip = $true
                          break 
                      }
                  }
                  
                  if (-not $skip) {
                      Write-Host "Installing: $line"
                      python -m pip install $line 2>&1 | Out-Null
                  }
              }
          }
          
          Write-Host "=== Verifying rembg installation ===" -ForegroundColor Cyan
          python -c "import rembg; print('rembg path:', rembg.__file__)"
          python -c "from rembg import remove, new_session; print('rembg functions OK')"
          python -c "import onnxruntime; print('onnxruntime providers:', onnxruntime.get_available_providers())"

      - name: Verify Icon File
        shell: pwsh
        run: |
          Write-Host "=== Checking icon file ===" -ForegroundColor Cyan
          $iconFile = "${{ inputs.icon_file }}"
          
          if (Test-Path $iconFile) {
              $fileSize = (Get-Item $iconFile).Length
              Write-Host "Icon file found: $iconFile ($fileSize bytes)" -ForegroundColor Green
          } else {
              Write-Host "ERROR: Icon file '$iconFile' not found!" -ForegroundColor Red
              Write-Host "Available .ico files:" -ForegroundColor Yellow
              Get-ChildItem -Filter "*.ico" | ForEach-Object { Write-Host "  - $($_.Name)" }
              exit 1
          }

      - name: Prepare Assets
        shell: pwsh
        run: |
          Write-Host "=== Preparing assets directory ===" -ForegroundColor Cyan
          
          if (-not (Test-Path "assets")) {
              New-Item -ItemType Directory -Path "assets" -Force | Out-Null
          }
          
          $iconFile = "${{ inputs.icon_file }}"
          if (Test-Path $iconFile) {
              Copy-Item -Path $iconFile -Destination "assets/" -Force
              Write-Host "Copied $iconFile to assets/" -ForegroundColor Green
          }
          
          New-Item -ItemType Directory -Path "biemo/models" -Force | Out-Null
          New-Item -ItemType Directory -Path "biemo/tools" -Force | Out-Null
          Set-Content -Path "biemo/models/.gitkeep" -Value ""
          Set-Content -Path "biemo/tools/.gitkeep" -Value ""
          Set-Content -Path "biemo/README.txt" -Value "Models and tools directory"
          
          Write-Host "Assets prepared successfully" -ForegroundColor Green

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # ÂåÖÂê´ÂÆåÊï¥ÁöÑÂåÖÔºàËÆ© Nuitka Ëá™Âä®Â§ÑÁêÜÂ≠êÊ®°ÂùóÔºâ
          include-package: |
            rembg
            onnxruntime
            imageio
            cv2
            numpy
            PIL
            psutil
            pooch
            scipy
            skimage
          
          # ÂåÖÂê´ÂåÖÊï∞ÊçÆÊñá‰ª∂ÔºàÊ®°ÂûãÊñá‰ª∂Á≠âÔºâ
          include-package-data: |
            rembg
            onnxruntime
            pooch
          
          # ÊéíÈô§‰∏çÈúÄË¶ÅÁöÑÊ®°Âùó
          nofollow-import-to: |
            sympy
            tkinter
            unittest
            test
            tests
            matplotlib.tests
            pytest
            setuptools
            distutils
            doctest
            numba
            numba.cuda
          
          enable-plugins: pyside6
          
          noinclude-numba-mode: nofollow
          noinclude-pytest-mode: nofollow
          noinclude-setuptools-mode: nofollow
          noinclude-unittest-mode: nofollow
          
          module-parameter: torch-disable-jit=yes
          
          include-data-dir: |
            assets=assets
            biemo=biemo
          
          include-data-files: ${{ inputs.icon_file }}=${{ inputs.icon_file }}
          
          windows-icon-from-ico: ${{ inputs.icon_file }}
          
          windows-console-mode: disable
          
          output-dir: build
          
          assume-yes-for-downloads: true
          
          lto: no
          low-memory: true
          jobs: 2
          
          company-name: Your Company
          product-name: Your Product
          file-version: 1.0.0.0
          product-version: 1.0.0.0
          file-description: Python Application

      - name: Verify Build Output
        shell: pwsh
        run: |
          Write-Host "=== Verifying build output ===" -ForegroundColor Cyan
          
          if (Test-Path "build") {
              $distDirs = Get-ChildItem -Path "build" -Filter "*.dist" -Directory
              if ($distDirs) {
                  foreach ($dist in $distDirs) {
                      Write-Host "Checking distribution: $($dist.Name)" -ForegroundColor Cyan
                      
                      # Ê£ÄÊü• rembg
                      $rembgPath = Join-Path $dist.FullName "rembg"
                      if (Test-Path $rembgPath) {
                          Write-Host "  ‚úì rembg package found" -ForegroundColor Green
                          Get-ChildItem $rembgPath -Recurse -Name | Select-Object -First 10 | ForEach-Object { Write-Host "    - $_" }
                      } else {
                          Write-Host "  ‚úó rembg package NOT found - this is a problem!" -ForegroundColor Red
                      }
                      
                      # Ê£ÄÊü• onnxruntime
                      $onnxPath = Join-Path $dist.FullName "onnxruntime"
                      if (Test-Path $onnxPath) {
                          Write-Host "  ‚úì onnxruntime package found" -ForegroundColor Green
                      } else {
                          Write-Host "  ‚úó onnxruntime package NOT found" -ForegroundColor Red
                      }
