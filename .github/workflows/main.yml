name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v5.0 ç¨³å®šä¿®å¤ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 120  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°120åˆ†é’Ÿï¼Œé¿å…å¤§å‹é¡¹ç›®è¶…æ—¶

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      # === 1. è™šæ‹Ÿå†…å­˜é…ç½® (é«˜å†…å­˜é˜²å´©æºƒ) ===
      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.4
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # ä½¿ç”¨3.11æ›´ç¨³å®šï¼Œ3.12å¯¹æŸäº›åŒ…æ”¯æŒå¯èƒ½ä¸å®Œæ•´
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸ›¡ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤
        shell: cmd
        run: |
          chcp 65001
          python -X utf8 -c "
import os, sys, subprocess
from pathlib import Path

# è®¾ç½®UTF-8ç¼–ç 
os.environ['PYTHONIOENCODING'] = 'utf-8'

print('=' * 30)
print('[ENV CHECK] Environment Setup')
print('=' * 30)

# ä¿®å¤ assets
assets_dir = Path('assets')
if not assets_dir.exists():
    print('[WARN] Creating empty assets directory...')
    assets_dir.mkdir()
    (assets_dir / '.keep').touch()

# å‡çº§ pip
print('[INFO] Upgrading pip...')
subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--upgrade', 'pip', '-q'])

# å®‰è£…åŸºç¡€å·¥å…·
print('[INFO] Installing build tools...')
subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'wheel', 'nuitka', 'zstandard', 'pillow', '-q'])

# å®‰è£… Torch CPU ç‰ˆæœ¬
print('[INFO] Installing CPU Torch...')
subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'torch', 'torchvision', 'torchaudio', '--index-url', 'https://download.pytorch.org/whl/cpu', '-q'])

# è§£æå¹¶å®‰è£… requirements.txt
if os.path.exists('requirements.txt'):
    print('[INFO] Parsing requirements.txt...')
    valid_deps = []
    encodings_to_try = ['utf-8', 'utf-8-sig', 'gbk', 'latin-1']
    lines = []
    
    for enc in encodings_to_try:
        try:
            with open('requirements.txt', 'r', encoding=enc) as f:
                lines = f.readlines()
            break
        except (UnicodeDecodeError, LookupError):
            continue
    
    skip_keywords = ['torch', 'pyside6', 'pyqt6', 'numba']
    for line in lines:
        line = line.strip()
        if not line or line.startswith('#'):
            continue
        line_lower = line.lower()
        if any(kw in line_lower for kw in skip_keywords):
            continue
        valid_deps.append(line)
    
    if valid_deps:
        print(f'[INFO] Installing {len(valid_deps)} dependencies...')
        try:
            subprocess.check_call([sys.executable, '-m', 'pip', 'install'] + valid_deps + ['-q'])
        except subprocess.CalledProcessError as e:
            print(f'[WARN] Some dependencies failed: {e}')
            # é€ä¸ªå®‰è£…ï¼Œè·³è¿‡å¤±è´¥çš„
            for dep in valid_deps:
                try:
                    subprocess.check_call([sys.executable, '-m', 'pip', 'install', dep, '-q'])
                except:
                    print(f'[WARN] Skipped: {dep}')
else:
    print('[WARN] No requirements.txt found, installing defaults...')
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'pygame', 'numpy', 'pandas', 'opencv-python', 'PyQt5', '-q'])

# å›¾æ ‡ç”Ÿæˆ
print('[INFO] Checking icon...')
from PIL import Image, ImageDraw
icon_target = 'icon.ico'
if not os.path.exists(icon_target):
    print('[WARN] Generating default icon...')
    img = Image.new('RGB', (256, 256), color=(0, 120, 215))
    d = ImageDraw.Draw(img)
    d.text((100, 110), 'APP', fill=(255, 255, 255))
    img.save(icon_target, format='ICO')
    print('[INFO] Default icon created.')

print('[INFO] Environment setup completed.')
"

      # === 2. Nuitka ç¼–è¯‘ ===
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === æ’é™¤ä¸éœ€è¦çš„æ¨¡å— ===
          nofollow-import-to: |
            sympy
            tkinter
            unittest
            test
            tests
            scipy.linalg
            matplotlib.tests
            pytest
            setuptools
            distutils
            doctest
          
          # å¯ç”¨ PyQt5 æ’ä»¶ (anti-bloat é»˜è®¤å·²å¯ç”¨ï¼Œä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®š)
          enable-plugins: pyqt5
          
          # å¤„ç† numba - ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ’é™¤ numba
          noinclude-numba-mode: nofollow
          
          # æ¨¡å—å‚æ•°é…ç½® - ç¦ç”¨ torch JIT
          module-parameter: torch-disable-jit=yes
          
          # åŒ…å«æ•°æ®æ–‡ä»¶
          include-data-dir: assets=assets
          
          # Windows å›¾æ ‡
          windows-icon-from-ico: icon.ico
          
          # æ§åˆ¶å°æ¨¡å¼ - ä½¿ç”¨æ–°çš„å‚æ•°å (GUIåº”ç”¨ç¦ç”¨æ§åˆ¶å°)
          windows-console-mode: disable
          
          # è¾“å‡ºç›®å½•
          output-dir: build
          
          # è‡ªåŠ¨ä¸‹è½½ä¾èµ–
          assume-yes-for-downloads: true
          
          # ç¦ç”¨ LTO åŠ é€Ÿç¼–è¯‘
          lto: no
          
          # ä½å†…å­˜æ¨¡å¼ - å‡å°‘å†…å­˜ä½¿ç”¨é¿å…å´©æºƒ
          low-memory: true
          
          # å…¬å¸ä¿¡æ¯
          company-name: "Your Company"
          product-name: "Your Product"
          file-version: "1.0.0.0"
          product-version: "1.0.0.0"
          file-description: "Python Application"

      # === 3. ä¸Šä¼ æ„å»ºäº§ç‰© ===
      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ inputs.build_mode }}
          path: |
            build/*.exe
            build/*.dist/
          retention-days: 30
          include-hidden-files: true  # é‡è¦ï¼šåŒ…å«éšè—æ–‡ä»¶å¦‚ .libs æ–‡ä»¶å¤¹

      # === 4. æ„å»ºä¿¡æ¯è¾“å‡º ===
      - name: ğŸ“Š Build Summary
        if: always()
        shell: cmd
        run: |
          chcp 65001
          python -X utf8 -c "
import os
from pathlib import Path

print('')
print('=' * 50)
print('[BUILD] Build Summary')
print('=' * 50)

build_dir = Path('build')
if build_dir.exists():
    files = list(build_dir.rglob('*.exe'))
    if files:
        print(f'')
        print(f'[SUCCESS] Generated {len(files)} executable(s):')
        for f in files:
            size_mb = f.stat().st_size / (1024 * 1024)
            print(f'  - {f.name} ({size_mb:.2f} MB)')
    else:
        print('')
        print('[WARN] No .exe files found')
        
    # åˆ—å‡º dist ç›®å½•
    dist_dirs = list(build_dir.glob('*.dist'))
    if dist_dirs:
        print(f'')
        print(f'[INFO] Distribution folders:')
        for d in dist_dirs:
            total_size = sum(f.stat().st_size for f in d.rglob('*') if f.is_file())
            print(f'  - {d.name} ({total_size / (1024 * 1024):.2f} MB total)')
else:
    print('')
    print('[ERROR] Build directory does not exist')
"
