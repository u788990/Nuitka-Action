name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ… (v4.0 æ€§èƒ½å¹³è¡¡ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 90  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°90åˆ†é’Ÿ
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      # === 1. è™šæ‹Ÿå†…å­˜é…ç½® (ä¿æŒé«˜å†…å­˜é˜²å´©æºƒ) ===
      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.3
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ğŸ›¡ï¸ ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤
        shell: python
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import os, sys, subprocess
          from pathlib import Path
          try: sys.stdout.reconfigure(encoding='utf-8')
          except: pass

          print(f"{'='*30}\nğŸ› ï¸ ç¯å¢ƒè‡ªæ£€\n{'='*30}")

          # ä¿®å¤ assets
          assets_dir = Path("assets")
          if not assets_dir.exists():
              print("âš ï¸ åˆ›å»ºç©º assets ç›®å½•...")
              assets_dir.mkdir()
              (assets_dir / ".keep").touch()

          # å®‰è£…ä¾èµ–
          print("ğŸ“¦ å®‰è£…ä¾èµ–...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"])
          subprocess.check_call([sys.executable, "-m", "pip", "install", "wheel", "nuitka", "zstandard", "pillow"])

          # å®‰è£… Torch CPU
          print("ğŸ”¥ å®‰è£… CPU ç‰ˆ Torch...")
          subprocess.check_call([sys.executable, "-m", "pip", "install", "torch", "torchvision", "torchaudio", "--index-url", "https://download.pytorch.org/whl/cpu"])

          # å®‰è£… requirements.txt
          if os.path.exists("requirements.txt"):
              print("ğŸ“š è§£æ requirements.txt...")
              valid_deps = []
              try:
                  with open("requirements.txt", "r", encoding="utf-8") as f: lines = f.readlines()
              except:
                  with open("requirements.txt", "r", encoding="gbk") as f: lines = f.readlines()
                      
              for line in lines:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  if "torch" in line.lower(): continue
                  if "pyside6" in line.lower(): continue 
                  if "pyqt6" in line.lower(): continue
                  valid_deps.append(line)
              
              if valid_deps:
                  print(f"ğŸ“¦ å®‰è£… {len(valid_deps)} ä¸ªé¡¹ç›®ä¾èµ–...")
                  subprocess.check_call([sys.executable, "-m", "pip", "install"] + valid_deps)
          else:
              print("âš ï¸ å®‰è£…é»˜è®¤ä¾èµ–...")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pygame", "numpy", "pandas", "opencv-python", "PyQt5"])

          # å›¾æ ‡ç”Ÿæˆ
          print("ğŸ¨ å›¾æ ‡æ£€æŸ¥...")
          from PIL import Image, ImageDraw
          icon_target = "icon.ico"
          if not os.path.exists(icon_target):
              print("âš ï¸ ç”Ÿæˆé»˜è®¤å›¾æ ‡...")
              img = Image.new('RGB', (256, 256), color = (0, 120, 215))
              d = ImageDraw.Draw(img)
              d.text((20,100), "APP", fill=(255,255,255))
              img.save(icon_target, format='ICO')

      # === 2. Nuitka ç¼“å­˜é…ç½® ===
      - name: Setup Nuitka Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/nuitka_cache
            ~\AppData\Local\Nuitka
          key: nuitka-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            nuitka-${{ runner.os }}-

      # === 3. Nuitka ç¼–è¯‘ ===
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === æ ¸å¿ƒä¼˜åŒ–ï¼šç˜¦èº«ä¸æ€§èƒ½ ===
          # æ’é™¤ä¸éœ€è¦çš„æ¨¡å—ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´å’Œä½“ç§¯
          nofollow-import-to: |
            sympy
            tkinter
            unittest
            test
            tests
            scipy.linalg
            matplotlib.tests
            numba.cuda
            numba.tests
            pytest
            setuptools
            distutils
            doctest
          
          # å¯ç”¨ PyQt5 æ’ä»¶
          enable-plugins: pyqt5,anti-bloat
          
          # æ¨¡å—å‚æ•°é…ç½®
          module-parameter: |
            numba-disable-jit=yes
            torch-disable-jit=yes
          
          # åŒ…å«æ•°æ®æ–‡ä»¶
          include-data-dir: assets=assets
          
          # Windows å›¾æ ‡
          windows-icon-from-ico: icon.ico
          
          # ç¦ç”¨æ§åˆ¶å°çª—å£ï¼ˆGUIåº”ç”¨ï¼‰
          windows-disable-console: true
          
          # è¾“å‡ºç›®å½•
          output-dir: build
          
          # è‡ªåŠ¨ä¸‹è½½ä¾èµ–
          assume-yes-for-downloads: true
          
          # ä¼˜åŒ–çº§åˆ«
          lto: no
          
          # å…¬å¸ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
          company-name: "Your Company"
          product-name: "Your Product"
          file-version: "1.0.0.0"
          product-version: "1.0.0.0"
          file-description: "Python Application"

      # === 4. ä¸Šä¼ æ„å»ºäº§ç‰© ===
      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ inputs.build_mode }}
          path: |
            build/*.exe
            build/*.dist/
          retention-days: 30

      # === 5. æ„å»ºä¿¡æ¯è¾“å‡º ===
      - name: ğŸ“Š Build Summary
        if: always()
        shell: python
        run: |
          import os
          from pathlib import Path
          
          print("\n" + "="*50)
          print("ğŸ‰ æ„å»ºå®Œæˆ")
          print("="*50)
          
          build_dir = Path("build")
          if build_dir.exists():
              files = list(build_dir.rglob("*.exe"))
              if files:
                  print(f"\nâœ… ç”Ÿæˆäº† {len(files)} ä¸ªå¯æ‰§è¡Œæ–‡ä»¶:")
                  for f in files:
                      size_mb = f.stat().st_size / (1024*1024)
                      print(f"  ğŸ“„ {f.name} ({size_mb:.2f} MB)")
              else:
                  print("\nâš ï¸ æœªæ‰¾åˆ° .exe æ–‡ä»¶")
          else:
              print("\nâŒ build ç›®å½•ä¸å­˜åœ¨")
          
          print("\nğŸ’¡ æç¤º: è¯·åœ¨ Actions é¡µé¢ä¸‹è½½æ„å»ºäº§ç‰©")
          print("="*50)
