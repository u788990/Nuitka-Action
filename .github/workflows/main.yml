name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ…

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬æ–‡ä»¶å (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼ (standalone=æ–‡ä»¶å¤¹, onefile=å•æ–‡ä»¶)'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

      include_assets:
        description: 'æ˜¯å¦åŒ…å« assets æ–‡ä»¶å¤¹'
        type: boolean
        required: false
        default: true

jobs:
  build:
    name: ğŸš€ Nuitka æ„å»º (Windows)
    runs-on: windows-latest
    
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel nuitka zstandard

          # å¼ºåˆ¶å®‰è£… CPU ç‰ˆ Torch (å‡å°ä½“ç§¯ï¼Œé˜²æ­¢æ‰“åŒ…å¡æ­»)
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…é¡¹ç›®å…¶ä»–çš„ä¾èµ–
          if (Test-Path "requirements.txt") {
            # æ’é™¤æ‰ requirements.txt é‡Œçš„ torch é˜²æ­¢è¦†ç›–å®‰è£…
            Get-Content requirements.txt | Where-Object { $_ -notmatch "torch" } | Set-Content requirements_no_torch.txt
            pip install -r requirements_no_torch.txt
          } else {
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° requirements.txtï¼Œå®‰è£…é»˜è®¤æ¸¸æˆåº“..."
            pip install pygame numpy pandas opencv-python pillow
          }

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          # === æ’ä»¶é…ç½® ===
          enable-plugins: numpy,torch,tk-inter,pyside6,pygame
          
          # === çª—å£ä¸æ§åˆ¶å°è®¾ç½® (è¿™é‡Œä¿®å¤äº†æŠ¥é”™) ===
          disable-console: true
          
          # å¦‚æœéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
          # windows-uac-admin: true
          
          # === ç¼–è¯‘ç¯å¢ƒ ===
          assume-yes-for-downloads: true
          lto: no  # å»ºè®®å…³é—­ LTO ä»¥æé«˜ GitHub Actions ä¸Šçš„æ‰“åŒ…æˆåŠŸç‡ï¼ˆé˜²æ­¢è¶…æ—¶ï¼‰
          
          # === å›¾æ ‡ (å¦‚æœæœ‰ icon.ico å­˜åœ¨åˆ™ç”Ÿæ•ˆ) ===
          # æ³¨æ„ï¼šå¦‚æœä½ çš„æ ¹ç›®å½•æ²¡æœ‰ icon.icoï¼Œè¯·åˆ é™¤ä¸‹é¢è¿™è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™
          # windows-icon-from-ico: icon.ico
          
          # === èµ„æºæ–‡ä»¶å¤„ç† ===
          # æ ¼å¼: æºè·¯å¾„=ç›®æ ‡è·¯å¾„
          include-data-dir: |
            ${{ inputs.include_assets && 'assets=assets' || '' }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
