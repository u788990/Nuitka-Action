name: Ultimate Nuitka Build (Auto-Fix Dependencies)

on:
  workflow_dispatch:
    inputs:
      entry_point:
        description: '入口 Python 文件'
        required: true
        default: 'biekuai.py'
      icon_file:
        description: '图标文件 (留空则自动检测)'
        required: false
        default: 'exe.ico'
      output_name:
        description: '生成的程序名称 (留空则使用入口文件名)'
        required: false
        default: ''
      build_mode:
        description: '打包模式'
        required: true
        default: 'onefile'
        type: choice
        options:
          - onefile
          - standalone

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # 注意：去掉 cache: pip，防止旧版本的残留包干扰环境

      - name: Free Disk Space (Deep Cleanup)
        shell: pwsh
        run: |
          Write-Host "Cleaning up disk..."
          Remove-TypeData * -ErrorAction SilentlyContinue
          $ErrorActionPreference = 'SilentlyContinue'
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidSDK"
          Remove-Item -Recurse -Force "$env:AGENT_TOOLSDIRECTORY\CodeQL"
          Remove-Item -Path "C:\Users\runneradmin\AppData\Local\Temp\*" -Recurse -Force
          [System.GC]::Collect()

      - name: Auto-Fix requirements.txt & Install
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            Write-Host ">>> Requirements.txt found. Cleaning conflict packages..."
            # 核心修复逻辑：
            # 自动删除 requirements.txt 中可能导致冲突的 zstandard 和 ordered-set 行
            # 让 pip 自动选择最适合 Nuitka 的版本，彻底解决 ResolutionImpossible 报错
            $content = Get-Content "requirements.txt" | Where-Object { $_ -notmatch "zstandard" -and $_ -notmatch "ordered-set" }
            $content | Set-Content "requirements_fixed.txt"
            
            Write-Host ">>> Installing cleaned dependencies..."
            pip install -r requirements_fixed.txt --upgrade
            # 补装 Nuitka 必需的加速库（不设版本号，自动匹配最新）
            pip install zstandard ordered-set
          } else {
            Write-Host ">>> No requirements.txt found. Installing default packages..."
            pip install zstandard ordered-set opencv-python==4.8.0.76 Pillow==10.2.0 numpy==1.26.4 tkinterdnd2==0.3.0
          }

      - name: Auto-Detect Nuitka Settings
        id: detect
        shell: pwsh
        run: |
          # 1. 入口文件检测
          $entry = "${{ github.event.inputs.entry_point }}"
          if (!(Test-Path $entry)) { $entry = Get-ChildItem -Filter "*.py" | Select-Object -First 1 -ExpandProperty Name }

          # 2. 分析插件需求
          $code = Get-Content $entry -Raw
          $plugins = @()
          $pkg_data = ""
          if ($code -match "PySide6") { $plugins += "pyside6" }
          if ($code -match "tkinter") { $plugins += "tk-inter" }
          if ($code -match "tkinterdnd2") { $pkg_data = "tkinterdnd2" }

          # 3. 图标检测
          $icon = "${{ github.event.inputs.icon_file }}"
          if ($icon -eq "" -or !(Test-Path $icon)) { 
            $foundIcon = Get-ChildItem -Filter "*.ico" | Select-Object -First 1
            $icon = if ($foundIcon) { $foundIcon.Name } else { "" } 
          }

          # 4. 程序名称确定
          $name = "${{ github.event.inputs.output_name }}"
          if ($name -eq "") { $name = [System.IO.Path]::GetFileNameWithoutExtension($entry) }

          echo "entry=$entry" >> $env:GITHUB_OUTPUT
          echo "name=$name" >> $env:GITHUB_OUTPUT
          echo "icon=$icon" >> $env:GITHUB_OUTPUT
          echo "plugins=$(($plugins | Select-Object -Unique) -join ',')" >> $env:GITHUB_OUTPUT
          echo "pkg_data=$pkg_data" >> $env:GITHUB_OUTPUT

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ steps.detect.outputs.entry }}
          output-file: ${{ steps.detect.outputs.name }}
          output-dir: build
          mode: ${{ github.event.inputs.build_mode }}
          
          # 插件与数据包含 (基于代码自动分析)
          enable-plugins: ${{ steps.detect.outputs.plugins }}
          include-package-data: ${{ steps.detect.outputs.pkg_data }}
          
          # 自动包含 FFmpeg 文件夹逻辑
          include-data-dir: ${{ hashFiles('fongzhuang/*') != '' && 'fongzhuang=fongzhuang' || '' }}
          
          # 核心：关闭盾牌图标，恢复拖拽功能
          windows-uac-admin: false
          disable-console: true
          windows-icon-from-ico: ${{ steps.detect.outputs.icon }}
          
          assume-yes-for-downloads: true
          onefile-tempdir-spec: "{CACHE_DIR}/${{ steps.detect.outputs.name }}/v1"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.detect.outputs.name }}-Binary
          path: build/*.exe
