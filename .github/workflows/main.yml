name: â˜ï¸ äº‘ç«¯ Nuitka æžé€Ÿæ‰“åŒ… (v5.1 ä¿®å¤ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬'
        required: true
        default: 'main.py'
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile
      
      icon_base_name:
        description: 'å›¾æ ‡æ–‡ä»¶åŸºç¡€åç§°ï¼ˆä¸å«å°ºå¯¸åŽç¼€ï¼‰'
        required: true
        default: 'icon'

jobs:
  build:
    name: ðŸš€ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.4
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        shell: pwsh
        run: |
          Write-Host "=== Upgrading pip ===" -ForegroundColor Cyan
          python -m pip install --upgrade pip
          
          Write-Host "=== Installing build tools ===" -ForegroundColor Cyan
          python -m pip install wheel nuitka zstandard pillow ordered-set
          
          Write-Host "=== Installing CPU Torch ===" -ForegroundColor Cyan
          python -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          
          Write-Host "=== Installing PySide6 ===" -ForegroundColor Cyan
          python -m pip install PySide6
          
          Write-Host "=== Installing rembg and onnxruntime ===" -ForegroundColor Cyan
          python -m pip install rembg onnxruntime
          
          Write-Host "=== Installing imageio ===" -ForegroundColor Cyan
          python -m pip install imageio imageio-ffmpeg
          
          Write-Host "=== Installing other dependencies ===" -ForegroundColor Cyan
          python -m pip install opencv-python numpy psutil
          
          Write-Host "=== Installing project dependencies ===" -ForegroundColor Cyan
          if (Test-Path "requirements.txt") {
              $content = Get-Content "requirements.txt" -Raw
              $lines = $content -split "`n"
              $skipKeywords = @("torch", "pyside6", "pyqt6", "numba", "cuda", "rembg", "onnxruntime", "imageio", "opencv", "numpy", "psutil")
              
              foreach ($line in $lines) {
                  $line = $line.Trim()
                  if ([string]::IsNullOrEmpty($line) -or $line.StartsWith("#")) { continue }
                  
                  $skip = $false
                  foreach ($kw in $skipKeywords) {
                      if ($line.ToLower().Contains($kw)) { 
                          Write-Host "Skipping: $line" -ForegroundColor Yellow
                          $skip = $true
                          break 
                      }
                  }
                  
                  if (-not $skip) {
                      Write-Host "Installing: $line"
                      python -m pip install $line 2>&1 | Out-Null
                      if ($LASTEXITCODE -ne 0) {
                          Write-Host "Warning: Failed to install $line" -ForegroundColor Yellow
                      }
                  }
              }
          }
          
          Write-Host "=== Verifying installations ===" -ForegroundColor Cyan
          python -c "import rembg; print('rembg OK')"
          python -c "import onnxruntime; print('onnxruntime OK')"
          python -c "import PySide6; print('PySide6 OK')"
          python -c "import cv2; print('opencv OK')"
          python -c "import imageio; print('imageio OK')"

      - name: Create Icon Script
        shell: pwsh
        run: |
          Set-Content -Path "create_icon.py" -Value @"
          from PIL import Image
          import os
          import sys

          icon_base = sys.argv[1] if len(sys.argv) > 1 else "icon"
          required_sizes = [16, 32, 48, 256]
          optional_sizes = [24, 64, 96, 128]
          all_sizes = sorted(set(required_sizes + optional_sizes))
          
          images = []
          source_image = None

          for size in sorted(all_sizes, reverse=True):
              patterns = [
                  f"{icon_base}_{size}x{size}.png",
                  f"{icon_base}_{size}x{size}.ico",
                  f"{icon_base}-{size}x{size}.png",
                  f"{icon_base}{size}.png",
              ]
              for pattern in patterns:
                  if os.path.exists(pattern):
                      try:
                          source_image = Image.open(pattern)
                          if source_image.mode != "RGBA":
                              source_image = source_image.convert("RGBA")
                          print(f"Found source: {pattern} ({source_image.size})")
                          break
                      except Exception as e:
                          print(f"Error loading {pattern}: {e}")
              if source_image:
                  break

          if not source_image:
              for ext in ['.png', '.ico', '.jpg', '.jpeg', '.bmp']:
                  base_file = f"{icon_base}{ext}"
                  if os.path.exists(base_file):
                      try:
                          source_image = Image.open(base_file)
                          if source_image.mode != "RGBA":
                              source_image = source_image.convert("RGBA")
                          print(f"Found base source: {base_file} ({source_image.size})")
                          break
                      except Exception as e:
                          print(f"Error loading {base_file}: {e}")

          if not source_image:
              print("No icon files found, creating default icon...")
              from PIL import ImageDraw
              source_image = Image.new("RGBA", (256, 256), (0, 120, 215, 255))
              draw = ImageDraw.Draw(source_image)
              draw.rectangle([20, 20, 235, 235], outline=(255, 255, 255, 255), width=8)

          for size in all_sizes:
              img = source_image.resize((size, size), Image.LANCZOS)
              images.append(img)
              print(f"Generated {size}x{size}")

          images_sorted = sorted(images, key=lambda x: x.size[0], reverse=True)
          images_sorted[0].save(
              "app_icon.ico",
              format="ICO",
              sizes=[(img.size[0], img.size[1]) for img in images_sorted],
              append_images=images_sorted[1:]
          )
          print(f"Created app_icon.ico with {len(images_sorted)} sizes")

          os.makedirs("icons", exist_ok=True)
          for img in images:
              size = img.size[0]
              img.save(f"icons/icon_{size}.png", format="PNG")
          print("Created PNG icons in icons/ folder")
          "@

      - name: Prepare Multi-Size Icon
        shell: pwsh
        run: |
          Write-Host "=== Creating Multi-Size ICO ===" -ForegroundColor Cyan
          python create_icon.py "${{ inputs.icon_base_name }}"
          
          if (Test-Path "app_icon.ico") {
              Write-Host "Multi-size icon created successfully!" -ForegroundColor Green
          } else {
              Write-Host "Failed to create icon!" -ForegroundColor Red
              exit 1
          }

      - name: Prepare Assets
        shell: pwsh
        run: |
          Write-Host "=== Preparing assets directory ===" -ForegroundColor Cyan
          
          if (-not (Test-Path "assets")) {
              New-Item -ItemType Directory -Path "assets" -Force | Out-Null
          }
          
          if (Test-Path "icons") {
              Copy-Item -Path "icons/*" -Destination "assets/" -Force
          }
          
          if (Test-Path "app_icon.ico") {
              Copy-Item -Path "app_icon.ico" -Destination "assets/" -Force
          }
          
          New-Item -ItemType Directory -Path "biemo/models" -Force | Out-Null
          New-Item -ItemType Directory -Path "biemo/tools" -Force | Out-Null

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          
          include-module: |
            rembg
            rembg.sessions
            rembg.sessions.u2net
            rembg.sessions.isnet
            rembg.sessions.base
            onnxruntime
            onnxruntime.capi
            onnxruntime.capi.onnxruntime_pybind11_state
            imageio
            imageio.core
            imageio.plugins
            cv2
            numpy
            PIL
            psutil
          
          include-package: |
            rembg
            onnxruntime
            imageio
          
          include-package-data: |
            rembg
            onnxruntime
            imageio
          
          nofollow-import-to: |
            sympy
            tkinter
            unittest
            test
            tests
            scipy.linalg
            matplotlib.tests
            pytest
            setuptools
            distutils
            doctest
            numba
            numba.cuda
            numba.tests
          
          enable-plugins: pyside6
          
          noinclude-numba-mode: nofollow
          noinclude-pytest-mode: nofollow
          noinclude-setuptools-mode: nofollow
          noinclude-unittest-mode: nofollow
          
          module-parameter: torch-disable-jit=yes
          
          include-data-dir: |
            assets=assets
            biemo=biemo
          
          include-data-files: app_icon.ico=app_icon.ico
          
          windows-icon-from-ico: app_icon.ico
          
          windows-console-mode: disable
          
          output-dir: build
          
          assume-yes-for-downloads: true
          
          lto: no
          
          low-memory: true
          
          jobs: 2
          
          company-name: Your Company
          product-name: Your Product
          file-version: 1.0.0.0
          product-version: 1.0.0.0
          file-description: Python Application

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ inputs.build_mode }}
          path: |
            build/*.exe
            build/*.dist/
          retention-days: 30
          include-hidden-files: true

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "Build Summary" -ForegroundColor Cyan
          Write-Host "==================================================" -ForegroundColor Cyan
          
          if (Test-Path "build") {
              $exeFiles = Get-ChildItem -Path "build" -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue
              if ($exeFiles -and $exeFiles.Count -gt 0) {
                  Write-Host ""
                  Write-Host "[SUCCESS] Generated $($exeFiles.Count) executable(s):" -ForegroundColor Green
                  foreach ($f in $exeFiles) {
                      $sizeMB = [math]::Round($f.Length / 1MB, 2)
                      Write-Host "  - $($f.Name) ($sizeMB MB)"
                  }
              } else {
                  Write-Host "[WARN] No .exe files found" -ForegroundColor Yellow
              }
              
              $distDirs = Get-ChildItem -Path "build" -Filter "*.dist" -Directory -ErrorAction SilentlyContinue
              if ($distDirs -and $distDirs.Count -gt 0) {
                  Write-Host ""
                  Write-Host "[INFO] Distribution folders:" -ForegroundColor Cyan
                  foreach ($d in $distDirs) {
                      $totalSize = (Get-ChildItem -Path $d.FullName -Recurse -File -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
                      if ($totalSize) {
                          $totalSizeMB = [math]::Round($totalSize / 1MB, 2)
                          Write-Host "  - $($d.Name) ($totalSizeMB MB total)"
                      }
                  }
              }
          } else {
              Write-Host "[ERROR] Build directory does not exist" -ForegroundColor Red
          }
