name: â˜ï¸ äº‘ç«¯ Nuitka æé€Ÿæ‰“åŒ…

# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ (Workflow Dispatch)
# è¿™æ ·ä½ å¯ä»¥åƒä½¿ç”¨ GUI è½¯ä»¶ä¸€æ ·è¾“å…¥å‚æ•°
on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Python å…¥å£è„šæœ¬æ–‡ä»¶å (ä¾‹å¦‚ main.py)'
        required: true
        default: 'main.py'  # ä¿®æ”¹è¿™é‡Œä¸ºä½ æ¸¸æˆçš„é»˜è®¤æ–‡ä»¶å
      
      build_mode:
        description: 'æ‰“åŒ…æ¨¡å¼ (standalone=æ–‡ä»¶å¤¹, onefile=å•æ–‡ä»¶)'
        required: true
        default: 'standalone' 
        type: choice
        options:
          - standalone
          - onefile

      include_assets:
        description: 'æ˜¯å¦åŒ…å« assets æ–‡ä»¶å¤¹ (é»˜è®¤åŒ…å«)'
        type: boolean
        required: false
        default: true

jobs:
  build:
    name: ğŸš€ Nuitka æ„å»º (Windows)
    runs-on: windows-latest
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Check-out repository
        uses: actions/checkout@v4

      # 2. é…ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # æ¨è 3.10ï¼Œå…¼å®¹æ€§æœ€å¥½
          cache: 'pip' # å¼€å¯ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡æ‰“åŒ…ä¼šå˜å¿«

      # 3. å®‰è£…ä¾èµ– (å…³é”®æ­¥éª¤)
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          
          # ä¼˜å…ˆå®‰è£… wheel å’Œ nuitka
          pip install wheel nuitka zstandard

          # --- é’ˆå¯¹æ¸¸æˆçš„ç‰¹æ®Šä¼˜åŒ– ---
          # å¦‚æœä½ çš„ requirements.txt é‡Œæœ‰ torchï¼ŒGitHub å¯èƒ½ä¼šä¸‹è½½å·¨å¤§çš„ CUDA ç‰ˆ
          # è¿™é‡Œå¼ºåˆ¶å®‰è£… CPU ç‰ˆ Torchï¼Œä½“ç§¯å‡å° 2GB+ï¼Œä¸”æ‰“åŒ…æ›´å¿«
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…é¡¹ç›®å…¶ä»–çš„ä¾èµ–
          if (Test-Path "requirements.txt") {
            # æ’é™¤æ‰ requirements.txt é‡Œçš„ torch é˜²æ­¢è¦†ç›–å®‰è£…
            Get-Content requirements.txt | Where-Object { $_ -notmatch "torch" } | Set-Content requirements_no_torch.txt
            pip install -r requirements_no_torch.txt
          } else {
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° requirements.txtï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…å¸¸ç”¨åº“..."
            pip install pygame numpy pandas opencv-python pillow
          }

      # 4. æ‰§è¡Œ Nuitka æ‰“åŒ…
      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          
          # æ¨¡å¼é€‰æ‹©
          mode: ${{ inputs.build_mode }}
          
          # --- æ’ä»¶é…ç½® (æ ¹æ®ä½ çš„é¡¹ç›®è‡ªåŠ¨å¼€å¯) ---
          # Nuitka-Action ä¼šè‡ªåŠ¨æ£€æµ‹ä»£ç é‡Œçš„ importï¼Œä½†æ˜¾å¼å¼€å¯æ›´ç¨³
          enable-plugins: numpy,torch,tk-inter,pyside6,pygame
          
          # --- é«˜çº§å‚æ•° ---
          # ç¦ç”¨æ§åˆ¶å°çª—å£ (æ¸¸æˆé€šå¸¸ä¸éœ€è¦é»‘æ¡†)
          windows-disable-console: true
          
          # è‡ªåŠ¨ä¸‹è½½ MinGW64 ç¼–è¯‘å™¨ (GitHub Actions ç¯å¢ƒä¼šè‡ªåŠ¨å¤„ç†)
          assume-yes-for-downloads: true
          
          # å¦‚æœä½ æœ‰å›¾æ ‡ï¼Œè¯·ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•æœ‰ icon.icoï¼Œæˆ–è€…åˆ é™¤è¿™è¡Œ
          # windows-icon-from-ico: icon.ico 
          
          # --- èµ„æºæ–‡ä»¶å¤„ç† ---
          # æ ¼å¼: æºè·¯å¾„=ç›®æ ‡è·¯å¾„
          # å¦‚æœä½ å‹¾é€‰äº† include_assets ä¸”ç›®å½•å­˜åœ¨ï¼Œè¿™é‡Œä¼šç”Ÿæ•ˆ
          # æ³¨æ„ï¼šéœ€è¦åœ¨ script-name åŒçº§ç›®å½•ä¸‹æœ‰ assets æ–‡ä»¶å¤¹
          include-data-dir: |
            ${{ inputs.include_assets && 'assets=assets' || '' }}

      # 5. ä¸Šä¼ æ‰“åŒ…ç»“æœ
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Game_Build_${{ github.run_number }}
          path: |
            build/*.exe
            build/*.dist/**/*
            build/*.bin
          if-no-files-found: warn
